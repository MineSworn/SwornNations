package com.massivecraft.factions.listeners;

import org.bukkit.Location;
import org.bukkit.Material;
import org.bukkit.block.Block;
import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.Listener;
import org.bukkit.event.block.BlockFromToEvent;
import org.bukkit.event.player.PlayerTeleportEvent;

import com.massivecraft.factions.Conf;

public class FactionsExploitListener implements Listener
{
	@EventHandler(priority = EventPriority.NORMAL)
	public void obsidianGenerator(BlockFromToEvent event)
	{
		if (event.isCancelled() || ! Conf.handleExploitObsidianGenerators)
			return;

		// Thanks to ObGenBlocker and WorldGuard for this method
		Block block = event.getToBlock();
		Material source = event.getBlock().getType();
		Material target = block.getType();
		if ((target == Material.REDSTONE_WIRE || target == Material.TRIPWIRE)
				&& (source == Material.AIR || source == Material.LAVA || source == Material.STATIONARY_LAVA))
			block.setType(Material.AIR);
	}

	@EventHandler(priority = EventPriority.NORMAL)
	public void enderPearlTeleport(PlayerTeleportEvent event)
	{
		if (event.isCancelled() || ! Conf.handleExploitEnderPearlClipping)
			return;

		if (event.getCause() != PlayerTeleportEvent.TeleportCause.ENDER_PEARL)
			return;

		// this exploit works when the target location is within 0.31 blocks or
		// so of a door or glass block or similar...
		// simple fix: ender pearl target locations are standardized to be in
		// the center (X/Z) of the target block, not at the edges
		Location target = event.getTo();
		target.setX(target.getBlockX() + 0.5);
		target.setZ(target.getBlockZ() + 0.5);
		event.setTo(target);
	}
}
